---
title: "TF family evolution"
author: "Arend Vancraeynest"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
                      warning=FALSE, 
                      message=FALSE,
                      tidy.opts=list(width.cutoff=60),
                      tidy=TRUE)
```

```{r here, message=FALSE, warning=FALSE, eval=FALSE}
# Load packages
library(here)
library(patchwork)
library(reshape2)
library(ggplot2)
library(Biostrings)
```

## Overview

In the previous part, the **tfhunter** package was used to find and count TF families for each species for which we had constructed a primary proteome.
Here, this data is used to construct heatmaps in order to further analyse differences in TF sizes between the selected *Brassicaceae* species. The final purpose will be to relate TF size discrepancies between species to biologically relevant characteristics/features.

## Species tree

```{r, fig.width=8, fig.height=8}
# A newick file with our relevant species was downloaded from TimeTree,
# and updated with the cultivars/subspecies, as well as refined based on the scientific literature
tree_file <- here("data", "Better_species_tree.nwk.txt")
tree <- treeio::read.newick(tree_file)
species_tree <- ggtree::ggtree(tree)

```


## Constructing heatmaps
### Generate a matrix based on the TF family counts
```{r}

# tf_file <- "https://raw.githubusercontent.com/almeidasilvaf/brassicaceae_tfs/main/products/tables/tf_families_per_species.tsv"

# load data and subset
# tf_data <- read.delim(tf_file, header=T)
# rownames(tf_data) <- tf_data$Family
# tf_data$Family <- NULL
# tf_species_matrix <- as.matrix(tf_data)

# tf_species_matrix <- tf_species_matrix[,ggtree::get_taxa_name(species_tree)]
```

```{r}
tf_file <- read.table(here("products", "tables", "TF_CountTable.txt"), header = T)
tf_species_matrix <- as.matrix(tf_file)
tf_species_matrix <- tf_species_matrix[,ggtree::get_taxa_name(species_tree)]
```



### Raw counts:
```{r}
# Construct the heatmap
df_raw <- melt(t(tf_species_matrix))
colnames(df_raw) <- c("Species", "TF", "Size")

q98.45 <- stats::quantile(df_raw$Size, probs = c(0.6, 0.8, 0.9, 0.95, 0.9845, 1), na.rm = TRUE)[5]
df_raw$high <- ifelse(df_raw$Size >= q98.45, 'yes', 'no')
df_raw$Species <- factor(df_raw$Species, levels = rev(ggtree::get_taxa_name(species_tree)))

plot_raw <- ggplot(df_raw, aes(x = TF, y = Species, fill = Size)) +
  geom_tile() +
  scale_fill_gradient(low = "#f3ffce", high = "#00441B", name = "TF count") +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, face = "bold"),
        axis.title.x = element_blank(),
        plot.title = ggtext::element_markdown(hjust = 0.5)
        ) + 
  labs(title = "**TF family sizes in *Brassicaceae* - Counts**") +
  geom_text(aes(x = TF, y = Species, label = Size, color = high),
                     size = 4) +
  scale_color_manual(
    values = c('no' = 'grey10', 'yes' = "grey90"), guide = "none",
  )

```


### TF sizes log2 rescaled
```{r}
# Generate a new matrix with log2-rescaled values
log2mat <- round(log2(tf_species_matrix + 1), 1)

# Construct the heatmap
df_log2rescaled <- melt(t(log2mat))
colnames(df_log2rescaled) <- c("Species", "TF", "Size")

q84 <- stats::quantile(df_log2rescaled$Size, probs = c(0, 0.25, 0.5, 0.75, 0.84, 1), na.rm = TRUE)[5]
df_log2rescaled$high <- ifelse(df_log2rescaled$Size >= q84, 'yes', 'no')
df_log2rescaled$Species <- factor(df_log2rescaled$Species, levels = rev(ggtree::get_taxa_name(species_tree)))

plot_log2 <- ggplot(df_log2rescaled, aes(x = TF, y = Species, fill = Size)) +
  geom_tile() +
  scale_fill_gradient(low = "#f3ffce", high = "#00441B", name = "TF count\n(log2)") +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, face = "bold"),
        axis.title.x = element_blank(),
        plot.title = ggtext::element_markdown(hjust = 0.5)
        ) + 
  labs(title = "**TF family sizes in *Brassicaceae* - log2 rescaled**") +
  geom_text(aes(x = TF, y = Species, label = Size, color = high),
                     size = 4) +
  scale_color_manual(
    values = c('no' = 'grey10', 'yes' = "grey90"), guide = "none",
  )
```


### TF sizes compared to *V.vinifera* sizes
```{r, fig.width=15, fig.height=10}
# Rescale to V.vinifera numbers (diploid base genome)
diploid <- as.data.frame(tf_species_matrix)$V.vinifera_cv.PN40024

vitis_resc_mat <- sweep(tf_species_matrix, 1, diploid, FUN = '/')
vitis_resc_mat <- log2(vitis_resc_mat + 1)
vitis_resc_mat <- round(vitis_resc_mat, 1)


# Construct the heatmap
df_vitis_resc <- melt(t(vitis_resc_mat))
colnames(df_vitis_resc) <- c("Species", "TF", "Size")

q97.4 <- stats::quantile(df_vitis_resc$Size, probs = c(0.6, 0.8, 0.9, 0.95, 0.974, 1), na.rm = TRUE)[5]
df_vitis_resc$high <- ifelse(df_vitis_resc$Size >= q97.4, 'yes', 'no')
df_vitis_resc$Species <- factor(df_vitis_resc$Species, levels = rev(ggtree::get_taxa_name(species_tree)))

plot_vitis <- ggplot(df_vitis_resc, aes(x = TF, y = Species, fill = Size)) +
  geom_tile() +
  scale_fill_gradient(low = "#f3ffce", high = "#00441B", name = "TF size\n(log2)") +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, face = "bold"),
        axis.title.x = element_blank(),
        plot.title = ggtext::element_markdown(hjust = 0.5)
        ) + 
  labs(title = "**TF family sizes in *Brassicaceae* - *Vitis* adjusted**") +
  geom_text(aes(x = TF, y = Species, label = Size, color = high),
                     size = 4) +
  scale_color_manual(
    values = c('no' = 'grey10', 'yes' = "grey90"), guide = "none",
  )

```


### Log2 + *V.vinifera* rescaled
```{r}
# 1) Take the log2
log2_vitis_mat <- log2(tf_species_matrix + 1)

# 2) Compare to Vitis' values
vitis <- as.data.frame(log2_vitis_mat)$V.vinifera_cv.PN40024
log2_vitis_mat <- sweep(log2_vitis_mat, 1, vitis, FUN = '/')
log2_vitis_mat <- round(log2_vitis_mat, 1)

# Construct the heatmap
df_log2vitis_resc <- melt(t(log2_vitis_mat))
colnames(df_log2vitis_resc) <- c("Species", "TF", "Size")

q99.6 <- stats::quantile(df_log2vitis_resc$Size, probs = c(0, 0.25, 0.5, 0.75, 0.996, 1), na.rm = TRUE)[5]
df_log2vitis_resc$high <- ifelse(df_log2vitis_resc$Size >= q99.6, 'yes', 'no')
df_log2vitis_resc$Species <- factor(df_log2vitis_resc$Species, levels = rev(ggtree::get_taxa_name(species_tree)))

plot_final <- ggplot(df_log2vitis_resc, aes(x = TF, y = Species, fill = Size)) +
  geom_tile() +
  scale_fill_gradient(low = "#faffd1", high = "#00441B", name = "Relative\nTF family\nsize") +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, face = "bold"),
        axis.title.x = element_blank(),
        plot.title = ggtext::element_markdown(hjust = 0.5)
        ) + 
  labs(title = "**TF family sizes in *Brassicaceae* - log2 and *Vitis* rescaled**") +
  geom_text(aes(x = TF, y = Species, label = Size, color = high),
                     size = 4) +
  scale_color_manual(
    values = c('no' = 'grey10', 'yes' = "grey90"), guide = "none",
  )
```


```{r}
# The display of the endpoint labels (aka species names) is improved:
# removed underscores, font converted into italics through a reach around
tree$tip.label <- gsub("_", " ", tree$tip.label)
tree$tip.label <- gsub("\\.([0-9]{1,2})$", "-\\1", tree$tip.label)

# Reach around: names enclosed by paste(italic()) as character strings and later within ggtree function parsed
tree$tip.label <- gsub("(.+)", "paste(italic('\\1'))", tree$tip.label)

species_tree_nice <- ggtree::ggtree(tree) +
  xlim(NA, 28) +
  ggtree::geom_tiplab(align=T, parse=T)

# Wrap the heatmaps together with the dendrogram
wrapped <- wrap_plots(species_tree_nice, plot_raw, widths = c(0.6, 2.4))
wrapped1 <- wrap_plots(species_tree_nice, plot_log2, widths = c(0.6, 2.4))
wrapped2 <- wrap_plots(species_tree_nice, plot_vitis, widths = c(0.6, 2.4))
wrapped3 <- wrap_plots(species_tree_nice, plot_final, widths = c(0.6, 2.4))


# Save the plots as PNGs
png(here("products", "plots", "Heatmap_RawCounts_Manual.png"),
    width = 2200, height = 1000)
wrapped
dev.off()

png(here("products", "plots", "Heatmap_log2Rescaled_Manual.png"),
    width = 2200, height = 1000)
wrapped1
dev.off()

png(here("products", "plots", "Heatmap_VitisRescaled_Manual.png"),
    width = 2200, height = 1000)
wrapped2
dev.off()

png(here("products", "plots", "Heatmap_FullyRescaled_Manual.png"),
    width = 2200, height = 1000)
wrapped3
dev.off()
```


## Session info

This document was created under the following conditions:

```{r sessioninfo}
sessionInfo()
```
